name: Build Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number'
        required: true
        default: '1.0.0'

jobs:
  build-linux-deb:
    name: Build DEB Package (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential
          sudo gem install fpm
      
      - name: Install Python dependencies
        working-directory: ./api
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${{ github.event.inputs.version || '1.0.0' }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Build DEB package
        working-directory: ./api
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          chmod +x build_fpm.sh
          ./build_fpm.sh
      
      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: api/build/fpm/*.deb
          compression-level: 0

  build-linux-rpm:
    name: Build RPM Package (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential rpm
          sudo gem install fpm
      
      - name: Install Python dependencies
        working-directory: ./api
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${{ github.event.inputs.version || '1.0.0' }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Build RPM package
        working-directory: ./api
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          chmod +x build_fpm.sh
          ./build_fpm.sh
      
      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: api/build/fpm/*.rpm
          compression-level: 0

  build-windows-exe:
    name: Build EXE (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            api/requirements.txt

      - name: Cache pip downloads (Windows)
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}\pip-cache
          key: ${{ runner.os }}-pip-${{ hashFiles('api/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache Nuitka build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ${{ runner.temp }}\nuitka-cache
            ${{ runner.temp }}\Nuitka
          key: ${{ runner.os }}-nuitka-${{ hashFiles('api/**/*.py', 'api/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-nuitka-
      
      - name: Install Python dependencies
        working-directory: ./api
        run: |
          python -m pip install --upgrade pip
          pip install --prefer-binary -r requirements.txt
          pip install nuitka
      
      - name: Build EXE with Nuitka
        working-directory: ./api
        run: |
          python nuitka_build.py
      
      - name: Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: exe-package
          path: api/build/nuitka/dist/*.exe
          compression-level: 0

  build-macos-app:
    name: Build App Bundle (macOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        working-directory: ./api
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install py2app
      
      - name: Build App bundle with Py2App
        working-directory: ./api
        run: |
          chmod +x build_py2app.sh
          chmod +x optimize_app.sh
          ./build_py2app.sh
      
      - name: Upload App artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-package
          path: api/build/py2app/dist/*.app
          compression-level: 0

  build-python-zip:
    name: Build Python Scripts ZIP
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${{ github.event.inputs.version || '1.0.0' }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Create ZIP archive
        working-directory: ./api
        run: |
          # Create temporary directory for ZIP contents
          mkdir -p ../zip_build
          
          # Copy Python scripts (excluding build-related files)
          cp app.py config_manager.py download_manager.py gui.py i18n.py main.py tray_app.py ../zip_build/
          
          # Copy configuration and requirements
          cp config.json requirements.txt ../zip_build/
          
          # Copy locales directory
          cp -r locales ../zip_build/
          
          # Copy documentation (optional but useful)
          cp README.md API_DOCUMENTATION.md ../zip_build/ 2>/dev/null || true
          
          # Create ZIP file
          cd ../zip_build
          zip -r spicedl2-api-scripts-${{ steps.version.outputs.version }}.zip .
      
      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-scripts-zip
          path: zip_build/spicedl2-api-scripts-${{ steps.version.outputs.version }}.zip
          compression-level: 0
          if-no-files-found: error
          retention-days: 1

  build-spicetify-extension:
    name: Build Spicetify Extension
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${{ github.event.inputs.version || '1.0.0' }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Spicetify CLI
        run: |
          yes n | curl -fsSL https://raw.githubusercontent.com/spicetify/spicetify-cli/master/install.sh | sh || true
          echo "$HOME/.spicetify" >> $GITHUB_PATH
      
      - name: Build extension
        run: npx spicetify-creator --out=dist --minify
      
      - name: Create ZIP archive
        run: |
          # Create ZIP file from dist directory
          if [ ! -d "dist" ]; then
            echo "Error: dist directory not found"
            ls -la
            exit 1
          fi
          cd dist
          zip -r ../spicedl2-extension-${{ steps.version.outputs.version }}.zip .
          cd ..
      
      - name: Upload extension artifact
        uses: actions/upload-artifact@v4
        with:
          name: spicetify-extension
          path: spicedl2-extension-${{ steps.version.outputs.version }}.zip
          compression-level: 0
          if-no-files-found: error
          retention-days: 1

  create-release:
    name: Create Release
    needs: [build-linux-deb, build-linux-rpm, build-windows-exe, build-macos-app, build-python-zip, build-spicetify-extension]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: false
      
      - name: Prepare release files
        run: |
          # Flatten artifact structure to avoid nested directories
          mkdir -p release_files
          mkdir -p temp_extract
          
          # Debug: List artifact structure
          echo "=== Artifact structure ==="
          find artifacts -type f | sort
          echo ""
          
          # Process each artifact directory
          # actions/download-artifact@v4 extracts ZIPs automatically, but we need to handle nested ZIPs
          
          # Process DEB files
          if [ -d "artifacts/deb-package" ]; then
            echo "Processing DEB package..."
            # Recursively find all .deb files
            find artifacts/deb-package -name "*.deb" -type f -exec cp {} release_files/ \;
            # If no .deb found, check for ZIP and extract
            if [ -z "$(find artifacts/deb-package -name "*.deb" -type f)" ]; then
              find artifacts/deb-package -name "*.zip" -type f | while read zipfile; do
                echo "Extracting DEB from ZIP: $zipfile"
                unzip -q "$zipfile" -d temp_extract/deb || true
                find temp_extract/deb -name "*.deb" -type f -exec cp {} release_files/ \;
              done
            fi
          fi
          
          # Process RPM files
          if [ -d "artifacts/rpm-package" ]; then
            echo "Processing RPM package..."
            # Recursively find all .rpm files
            find artifacts/rpm-package -name "*.rpm" -type f -exec cp {} release_files/ \;
            # If no .rpm found, check for ZIP and extract
            if [ -z "$(find artifacts/rpm-package -name "*.rpm" -type f)" ]; then
              find artifacts/rpm-package -name "*.zip" -type f | while read zipfile; do
                echo "Extracting RPM from ZIP: $zipfile"
                unzip -q "$zipfile" -d temp_extract/rpm || true
                find temp_extract/rpm -name "*.rpm" -type f -exec cp {} release_files/ \;
              done
            fi
          fi
          
          # Process EXE files
          if [ -d "artifacts/exe-package" ]; then
            echo "Processing EXE package..."
            # Recursively find all .exe files
            find artifacts/exe-package -name "*.exe" -type f -exec cp {} release_files/ \;
            # If no .exe found, check for ZIP and extract
            if [ -z "$(find artifacts/exe-package -name "*.exe" -type f)" ]; then
              find artifacts/exe-package -name "*.zip" -type f | while read zipfile; do
                echo "Extracting EXE from ZIP: $zipfile"
                unzip -q "$zipfile" -d temp_extract/exe || true
                find temp_extract/exe -name "*.exe" -type f -exec cp {} release_files/ \;
              done
            fi
          fi
          
          # Process APP bundles
          if [ -d "artifacts/app-package" ]; then
            echo "Processing APP package..."
            # Recursively find all .app directories
            find artifacts/app-package -name "*.app" -type d -exec cp -r {} release_files/ \;
            # If no .app found, check for ZIP and extract
            if [ -z "$(find artifacts/app-package -name "*.app" -type d)" ]; then
              find artifacts/app-package -name "*.zip" -type f | while read zipfile; do
                echo "Extracting APP from ZIP: $zipfile"
                unzip -q "$zipfile" -d temp_extract/app || true
                find temp_extract/app -name "*.app" -type d -exec cp -r {} release_files/ \;
              done
            fi
          fi
          
          # Process Python scripts ZIP
          # This should remain as a ZIP file, but we need to extract it from the artifact wrapper ZIP
          if [ -d "artifacts/python-scripts-zip" ]; then
            echo "Processing Python scripts ZIP..."
            # Find all ZIP files and process them
            find artifacts/python-scripts-zip -name "*.zip" -type f | while read zipfile; do
              echo "Checking ZIP file: $zipfile"
              # Check if this ZIP contains another ZIP file
              if unzip -l "$zipfile" 2>/dev/null | grep -q "\.zip$"; then
                echo "ZIP contains another ZIP, extracting inner ZIP..."
                unzip -q "$zipfile" -d temp_extract/python-zip || true
                # Copy the inner ZIP file(s)
                find temp_extract/python-zip -name "*.zip" -type f -exec cp {} release_files/ \;
              else
                # Check if this is a single-file ZIP (likely the actual scripts ZIP)
                # or a multi-file ZIP (likely the artifact wrapper)
                file_count=$(unzip -l "$zipfile" 2>/dev/null | tail -n +4 | head -n -2 | wc -l)
                if [ "$file_count" -eq 1 ]; then
                  # Single file - might be the wrapper, extract to check
                  echo "Single-file ZIP, extracting to check contents..."
                  unzip -q "$zipfile" -d temp_extract/python-zip-check || true
                  # If extracted content is a ZIP, use it; otherwise use original
                  if find temp_extract/python-zip-check -name "*.zip" -type f | grep -q .; then
                    find temp_extract/python-zip-check -name "*.zip" -type f -exec cp {} release_files/ \;
                  else
                    cp "$zipfile" release_files/
                  fi
                  rm -rf temp_extract/python-zip-check
                else
                  # Multi-file ZIP - this is likely the actual scripts ZIP
                  echo "Multi-file ZIP, using as Python scripts ZIP"
                  cp "$zipfile" release_files/
                fi
              fi
            done
          fi
          
          # Process Spicetify extension ZIP
          # This should remain as a ZIP file, but we need to extract it from the artifact wrapper ZIP
          if [ -d "artifacts/spicetify-extension" ]; then
            echo "Processing Spicetify extension ZIP..."
            # Find all ZIP files and process them
            find artifacts/spicetify-extension -name "*.zip" -type f | while read zipfile; do
              echo "Checking ZIP file: $zipfile"
              # Check if this ZIP contains another ZIP file
              if unzip -l "$zipfile" 2>/dev/null | grep -q "\.zip$"; then
                echo "ZIP contains another ZIP, extracting inner ZIP..."
                unzip -q "$zipfile" -d temp_extract/extension-zip || true
                # Copy the inner ZIP file(s)
                find temp_extract/extension-zip -name "*.zip" -type f -exec cp {} release_files/ \;
              else
                # Check if this is a single-file ZIP (likely the actual extension ZIP)
                # or a multi-file ZIP (likely the artifact wrapper)
                file_count=$(unzip -l "$zipfile" 2>/dev/null | tail -n +4 | head -n -2 | wc -l)
                if [ "$file_count" -eq 1 ]; then
                  # Single file - might be the wrapper, extract to check
                  echo "Single-file ZIP, extracting to check contents..."
                  unzip -q "$zipfile" -d temp_extract/extension-zip-check || true
                  # If extracted content is a ZIP, use it; otherwise use original
                  if find temp_extract/extension-zip-check -name "*.zip" -type f | grep -q .; then
                    find temp_extract/extension-zip-check -name "*.zip" -type f -exec cp {} release_files/ \;
                  else
                    cp "$zipfile" release_files/
                  fi
                  rm -rf temp_extract/extension-zip-check
                else
                  # Multi-file ZIP - this is likely the actual extension ZIP
                  echo "Multi-file ZIP, using as Spicetify extension ZIP"
                  cp "$zipfile" release_files/
                fi
              fi
            done
          fi
          
          # Clean up temporary extraction directory
          rm -rf temp_extract
          
          # List files for verification
          echo "=== Release files prepared ==="
          ls -lh release_files/
          echo ""
          echo "=== File types in release_files ==="
          for f in release_files/*; do
            if [ -f "$f" ]; then
              echo "$(basename "$f"): $(file "$f" | cut -d: -f2-)"
            elif [ -d "$f" ]; then
              echo "$(basename "$f"): directory"
            fi
          done
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release_files/*
          tag_name: ${{ github.ref_name }}
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## SpiceDL ${{ steps.version.outputs.version }}
            
            ### ダウンロード
            
            #### API Server
            - **Linux (Debian/Ubuntu)**: `.deb` パッケージ
            - **Linux (Red Hat/CentOS/Fedora)**: `.rpm` パッケージ
            - **Windows**: `.exe` 実行ファイル
            - **macOS**: `.app` アプリケーションバンドル
            - **Pythonスクリプト**: `.zip` ファイル（直接実行用）
            
            #### Spicetify Extension
            - **Extension**: `.zip` ファイル
            
            ### インストール方法
            
            #### API Server
            
            ##### DEB (Debian/Ubuntu)
            ```bash
            sudo dpkg -i spicedl2-api_*.deb
            sudo apt-get install -f  # 依存関係の解決
            ```
            
            ##### RPM (Red Hat/CentOS/Fedora)
            ```bash
            sudo rpm -i spicedl2-api-*.rpm
            ```
            
            ##### Windows
            `.exe` ファイルをダウンロードして実行してください。
            
            ##### macOS
            `.app` バンドルをダウンロードして、アプリケーションフォルダに移動してください。
            
            ##### Pythonスクリプト（直接実行用）
            ZIPファイルを展開し、以下のコマンドで依存関係をインストールしてから実行してください：
            ```bash
            pip install -r requirements.txt
            python app.py
            ```
            
            #### Spicetify Extension
            1. ZIPファイルをダウンロードして展開
            2. 展開したファイルをSpicetifyの拡張機能ディレクトリにコピー：
               ```bash
               # Windows
               %USERPROFILE%\.spicetify\Extensions\spicedl\
               
               # macOS/Linux
               ~/.spicetify/Extensions/spicedl/
               ```
            3. Spicetifyを再適用：
               ```bash
               spicetify apply
               ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

