name: Build Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number'
        required: true
        default: '1.0.0'

jobs:
  build-linux-deb:
    name: Build DEB Package (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential
          sudo gem install fpm
      
      - name: Install Python dependencies
        working-directory: ./api
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${{ github.event.inputs.version || '1.0.0' }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Build DEB package
        working-directory: ./api
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          chmod +x build_fpm.sh
          ./build_fpm.sh
      
      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: api/build/fpm/*.deb

  build-linux-rpm:
    name: Build RPM Package (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential rpm
          sudo gem install fpm
      
      - name: Install Python dependencies
        working-directory: ./api
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${{ github.event.inputs.version || '1.0.0' }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Build RPM package
        working-directory: ./api
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          chmod +x build_fpm.sh
          ./build_fpm.sh
      
      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: api/build/fpm/*.rpm

  build-windows-exe:
    name: Build EXE (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            api/requirements.txt

      - name: Cache pip downloads (Windows)
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}\pip-cache
          key: ${{ runner.os }}-pip-${{ hashFiles('api/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache Nuitka build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ${{ runner.temp }}\nuitka-cache
            ${{ runner.temp }}\Nuitka
          key: ${{ runner.os }}-nuitka-${{ hashFiles('api/**/*.py', 'api/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-nuitka-
      
      - name: Install Python dependencies
        working-directory: ./api
        run: |
          python -m pip install --upgrade pip
          pip install --prefer-binary -r requirements.txt
          pip install nuitka
      
      - name: Build EXE with Nuitka
        working-directory: ./api
        run: |
          python nuitka_build.py
      
      - name: Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: exe-package
          path: api/build/nuitka/dist/*.exe

  build-macos-app:
    name: Build App Bundle (macOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        working-directory: ./api
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install py2app
      
      - name: Build App bundle with Py2App
        working-directory: ./api
        run: |
          chmod +x build_py2app.sh
          chmod +x optimize_app.sh
          ./build_py2app.sh
      
      - name: Upload App artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-package
          path: api/build/py2app/dist/*.app

  build-python-zip:
    name: Build Python Scripts ZIP
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${{ github.event.inputs.version || '1.0.0' }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Prepare ZIP contents
        working-directory: ./api
        run: |
          # Create temporary directory for ZIP contents
          mkdir -p ../zip_build
          
          # Copy Python scripts (excluding build-related files)
          cp app.py config_manager.py download_manager.py gui.py i18n.py main.py tray_app.py ../zip_build/
          
          # Copy requirements
          cp requirements.txt ../zip_build/
          
          # Copy locales directory
          cp -r locales ../zip_build/
          
          # Copy documentation (optional but useful)
          cp README.md API_DOCUMENTATION.md ../zip_build/ 2>/dev/null || true
      
      - name: Upload ZIP contents artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-scripts-zip
          path: zip_build
          if-no-files-found: error
          retention-days: 1

  build-spicetify-extension:
    name: Build Spicetify Extension
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${{ github.event.inputs.version || '1.0.0' }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Spicetify CLI
        run: |
          yes n | curl -fsSL https://raw.githubusercontent.com/spicetify/spicetify-cli/master/install.sh | sh || true
          echo "$HOME/.spicetify" >> $GITHUB_PATH
      
      - name: Build extension
        run: npx spicetify-creator --out=dist --minify
      
      - name: Upload extension artifact
        uses: actions/upload-artifact@v4
        with:
          name: spicetify-extension
          path: dist
          if-no-files-found: error
          retention-days: 1

